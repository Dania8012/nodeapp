# cd-pipeline.yml
trigger:
  branches:
    include:
    - main
  paths:
    include:
    - eks_resources/**

# resources:
#   pipelines:
#   - pipeline: ci-pipeline
#     source: 'ci-pipeline'
#     trigger: true

stages:
- stage: Validate
  jobs:
  - job: ValidateManifests
    steps:
    - script: |
        # Install kubeval (Linux)
        echo "Installing kubeval..."
        sudo curl -sSL -o /usr/local/bin/kubeval https://github.com/instrumenta/kubeval/releases/latest/download/kubeval-linux-amd64
        sudo chmod +x /usr/local/bin/kubeval
        
        # Verify installation
        kubeval --version
        
        # Validate manifests
        echo "Validating Kubernetes manifests..."
        kubeval --strict eks_resources/*.yaml
      displayName: 'Validate with kubeval'

- stage: Deploy
  dependsOn: Validate
  jobs:
  - deployment: DeployToAKS
    environment: 'dev'
    strategy:
      runOnce:
        deploy:
          steps:
          - checkout: self
          - task: KubernetesManifest@0
            inputs:
              action: 'deploy'
              kubernetesServiceConnection: 'aksconn'
              namespace: 'default'
              manifests: 'eks_resources/*.yaml'